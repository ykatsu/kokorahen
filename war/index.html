<!doctype html>
<html>
  <head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta id="viewport" name="viewport"
		content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />

    <title>ここらへん</title>
    <style type="text/css" media="screen">@import "/jQtouch/jqtouch/jqtouch.css";</style>
    <style type="text/css" media="screen">@import "/jQtouch/themes/jqt/theme.css";</style>
	<style type="text/css" media="screen">@import "/jQtouch/extensions/jqt.bars/jqt.bars.css";</style>
	<style type="text/css" media="screen">@import "/jQtouch/extensions/jqt.bars/themes/jqt/theme.css";</style>
	<style type="text/css" media="screen">@import "/jQtouch/extensions/jqt.listIndex/jqt.listIndex.css";</style>


	<script src="/js/jquery-1.6.0.js" ></script>
	<script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript" ></script>

<!--
	<script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript" ></script>
-->
	<script src="/jQtouch/jqtouch/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>
	<script src="/jQtouch/extensions/jqt.autotitles.js" type="application/x-javascript" charset="utf-8"></script>
	<script src="/jQtouch/extensions/jqt.bars/jqt.bars.js" type="application/x-javascript" charset="utf-8"></script>
	<script src="/jQtouch/extensions/jqt.listIndex/jqt.listIndex.js" type="application/x-javascript" charset="utf-8"></script>


	<script src="/stub/org/kotemaru/kokorahen/jsrpc/Kokorahen.js" ></script>

	<script type="text/javascript" charset="utf-8">
		var jqt = $.jQTouch({
			useFastTouch: true
		});

		$(function(){
			initMap();

			// custom event listener setup.
			$('#spot').bind('pageAnimationEnd', onShowSpot);

			// 補助マップのスクロールで親ページがスクロールしないようにしている。
			function eventBreaker(ev) {
				ev.preventDefault();
				return false;
			}
			$('#mapCanvas2').bind('touchmove', eventBreaker);
			$('#mapCanvas2').bind('mousemove', eventBreaker);
		});


		var map;
		var map2;
		var currentMarker;

		function initMap() {

			updateOrientation();

			// デフォルト中心、皇居
			var center = new google.maps.LatLng(35.684699,139.753897);

			// マップ生成
			var mapopts = {
				zoom: 14,
				center: center,
				scaleControl: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			map = new google.maps.Map(document.getElementById("mapCanvas"),mapopts);
			var mapopts2 = {
					zoom: 18,
					center: center,
					scaleControl: false, disableDefaultUI: true,
					mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			map2 = new google.maps.Map(document.getElementById("mapCanvas2"),mapopts2);

			// 現在位置マーカー生成
			marker = new google.maps.Marker({position: center, map: map });
			marker2 = new google.maps.Marker({position: center, map: map2 });

			// マップ、バルーンのイベントハンドラ設定。
			google.maps.event.addListener(map, 'click', onMapClick);
			google.maps.event.addListener(map, 'idle', onMapIdol);
			google.maps.event.addListener(marker, 'click', onMarkerClick);
			google.maps.event.addListener(map2, 'click', onMap2Click);
			//google.maps.event.addListener(balloon, 'domready', onLoadBalloon);

			// GPSから現在位置取得、
			navigator.geolocation.getCurrentPosition(geoUpdate,
					function(e){alert(""+e)});
		}
		/**
		 * GPS取得イベント処理。
		 * <li>navigator.geolocation.watchPosition()
		 */
		function geoUpdate(position) {
			var lat = position.coords.latitude;
			var lng = position.coords.longitude;
			// 地図の中央にGPS位置を設定。
			center = new google.maps.LatLng(lat, lng);
			map.setCenter(center);
			marker.setPosition(center);
			// グルグルを消す
			//waitingIcon(false);
			// 現在位置マーカーをGPS位置に移動。
			//onMapClick({latLng: center});
		}

		/**
		 * マップクリックイベント処理。
		 */
		function onMapClick(ev) {
			// 現在位置マーカをクリック位置に移動。
			marker.setPosition(ev.latLng);
			marker.setVisible(true);
		}
		function onMarkerClick(ev) {
			currentMarker = this;
			jqt.goTo("#spot", "slideleft");
		}
		function onMap2Click(ev) {
			marker2.setPosition(ev.latLng);
			marker2.setVisible(true);
			setSpotPos(marker2.getPosition());
		}

		function updateOrientation() {
			//alert(""+$("html").height());

			var h1 = 45; // $("#mapHeader").height();
			var h2 = $("#tabbar").height();
			$("#mapCanvas").height($("html").height() - h1 - h2);
			//window.setTimeout(function(){
			//window.scrollTo(0, 1)
			//$("#map").height($("body").height()-45);
			//}, 100);
		}

		function onShowSpot(ev, info){
			if ($('#spot').is(':hidden')) return;

			var pos;
			google.maps.event.trigger(map2, "resize");

			var spotForm = document.spot;
			var sd = currentMarker.spotData;
			if (sd == null) {
				pos = currentMarker.getPosition();

				spotForm.id.value = "";
				spotForm.lat.value = "";
				spotForm.lng.value = "";
				spotForm.address.value = "";
				spotForm.name.value = "";
				spotForm.openHours.value = "";
				spotForm.closedDay.value = "";
				spotForm.email.value = "";
				spotForm.url.value = "";
				spotForm.comment.value = "";
				spotForm.tags.value = "";
				spotForm.image.value = "";
				$("#spotImage").attr("src", "/images/Home.png");

				setSpotPos(pos);
			} else {
				pos = new google.maps.LatLng(sd.lat, sd.lng);

				spotForm.id.value = sd.id;
				spotForm.lat.value = sd.lat;
				spotForm.lng.value = sd.lng;
				spotForm.address.value = sd.address;
				spotForm.name.value = sd.name;
				spotForm.openHours.value = sd.openHours;
				spotForm.closedDay.value = sd.closedDay;
				spotForm.email.value = sd.email;
				spotForm.url.value = sd.url;
				spotForm.comment.value = sd.comment;
				spotForm.tags.value = sd.tags.join(",");
				spotForm.image.value = sd.image;
				if (sd.image != null && sd.image != "") {
					$("#spotImage").attr("src", sd.image);
				}
			}

			marker2.setPosition(pos);
			marker2.setVisible(true);
			map2.setCenter(pos);
		};
		function setSpotPos(pos){
			var spotForm = document.spot;
			spotForm.lat.value = pos.lat();
			spotForm.lng.value = pos.lng();

			// 座標から住所を取得しinputタグに設定。
			var geocoder = new google.maps.Geocoder();
			geocoder.geocode({latLng: pos}, function(results, status){
				var addr = "???";
				if(status == google.maps.GeocoderStatus.OK){
					addr = results[0].formatted_address;
				}
				spotForm.address.value = addr;
			});
		};


		function writeSpot() {
			var params = {};
			var elems = document.spot.elements;
			for (var i=0; i<elems.length; i++) {
				params[elems[i].name] = elems[i].value;
			}
			var id = Kokorahen.writeSpot(params);
			alert("sopt id="+id);
		}

		// ピンイメージ。
		var pinImage = new google.maps.MarkerImage(
			"http://maps.google.co.jp/mapfiles/ms/icons/blue-pushpin.png", // url
			new google.maps.Size(32,32), // size
			new google.maps.Point(0,0),  // origin
			new google.maps.Point(10,30) // anchor
		);
		// ピンの影イメージ
		var pinShadowImage = new google.maps.MarkerImage(
		    "http://maps.google.co.jp/mapfiles/ms/icons/pushpin_shadow.png", // url
		    new google.maps.Size(32,32), // size
		    new google.maps.Point(0,0),  // origin
		    new google.maps.Point(8,31) // anchor
		);
		var markers = {}; // マーカーの一覧。
		var areaFlags = {}; // 取得済みエリアの一覧。

		/**
		 * マップクリックイベント処理。
		 */
		function onMapIdol() {

			// マップの表示範囲取得。
			var rect = map.getBounds();
			if (rect == null) return;
			var latNE = rect.getNorthEast().lat();
			var lngNE = rect.getNorthEast().lng();
			var latSW = rect.getSouthWest().lat();
			var lngSW = rect.getSouthWest().lng();

			// サーバーから表示範囲内のマーカー取得。非同期。
			Kokorahen.getAreasAsync({
				send: function(areas) {
					for(var i=0; i<areas.length; i++) {
						var area = areas[i];
						if (!areaFlags[area]) {
							Kokorahen.listSpotAsync(protMarkers, {area: area});
							areaFlags[area] = true;
						}
					}
				},
				_throw: function (e) {
					alert(e);
				}
			}, {
				maxLat: Math.max(latNE, latSW),
				minLat: Math.min(latNE, latSW),
				maxLng: Math.max(lngNE, lngSW),
				minLng: Math.min(lngNE, lngSW),
			});

		};

		/**
		 * 表示範囲内のマーカー取得コールバック。
		 */
		var protMarkers = {
			send: function(list) {
				//for (var key in markers) markers[key].setVisible(false);
				for (var i=0; i<list.length; i++) {
					var id = list[i].id;
					if (markers[id] == null) {
						// まだ無い場合は青ピンマーカーを生成する。
						var pos = new google.maps.LatLng(list[i].lat, list[i].lng);
						var m = new google.maps.Marker({position: pos, map: map,
								icon:pinImage, shadow:pinShadowImage
						});
						google.maps.event.addListener(m, 'click', onMarkerClick);
						m.spotData = list[i];
						markers[id] = m;
					} else {
						// 既に有る場合は表示を有効にする。
						markers[id].setVisible(true);
					}
				}
			},
			_throw: function(e) {
				alert(e);
			}
		}

	</script>
	<style type="text/css" media="screen">
		html, body {
			width: 100%;
			height: 100%;
		}
		#map {
			height: 100%;
		}
		#mapCanvas2 {
			width: 290px;
			height: 200px;
			margin: 4px auto 4px auto;
		}

	</style>
</head>

<body onorientationchange="updateOrientation();" onresize="updateOrientation();">
<!-- tabbar -->
<div id="tabbar">
	<div>
	<ul>
		<li><a href="#map" mask="/images/location_pin.png" ><strong>Map</strong></a></li>
		<li><a href="#timeline" mask="/images/clock_time.png" ><strong>TimeLine</strong></a></li>
		<li><a href="#list" mask="/images/list.png" ><strong>List</strong></a></li>
		<li><a href="#memo" mask="/images/edit.png" ><strong>Memo</strong></a></li>
		<li><a href="#config" mask="/images/preferences_gear_5.png" ><strong>Config</strong></a></li>
	</ul>
	</div>
</div>

<div id="jqt">
	<div id="map" class="keep_tabbar">
		<div id="mapHeader" class="toolbar">
			<h1>ここらへん</h1>
			<!--
			<a class="back slideright" href="#home">back</a>
			<a class="button slideleft" id="infoButton" href="#memo">add</a>
			-->
		</div>
		<div id="mapCanvas">
		</div>
    </div>


	<div id="spot"  class="keep_tabbar">
		<div class="toolbar">
			<h1>Spot情報</h1>
			<a class="back slideright" href="#map">Map</a>
			<a class="button" id="infoButton" href="javascript:writeSpot()">登録</a>
		</div>
		<div class="s-scrollwrapper">
		<div>
		<form action="" name="spot">
			<input name="id" type="hidden"/>
			<input name="lat" type="hidden"/>
			<input name="lng" type="hidden"/>



			<img id="spotImage" src="/images/Home.png" width="45%"  Align="left" onclick="$('#spotImageUrl').focus()"/>
			<br/><br/>
			<input type="text" name="name" placeholder="名前" style="font-size:20px;width:50%;" />
			<br/><br/>
			<input id="spotImageUrl" type="url" name="image" placeholder="画像URL"
					style="font-size:14px;width:50%;"
					onchange="$('#spotImage').attr('src', this.value)" />
			<a href="https://picasaweb.google.com/home" target="_blank" ><img src="http://lh5.googleusercontent.com/s/v/79.06/img/logo/pwa-ja.gif"/></a>

			<br clear="left" />


			<ul class="edit rounded">
				<li><input type="text" name="address" placeholder="住所"/></li>
				<li><input type="text" name="tags" placeholder="タグ"/></li>
				<li><input type="text" name="openHours" placeholder="営業時間"/></li>
				<li><input type="text" name="closedDay" placeholder="定休日"/></li>
				<li><input type="email" name="email" placeholder="E-Mail"/></li>
				<li><input type="url" name="url" placeholder="URL"/></li>
				<li><input type="text" name="comment" placeholder="備考"/></li>
			</ul>

			<div id="mapCanvas2">
			</div>
		</form>
		</div>
		</div>
	</div>

	<div id="timeline" class="keep_tabbar">
		<div class="toolbar">
			<h1>TimeLine</h1>
		</div>
		<div class="s-scrollwrapper">
			<div>
			工事中
			</div>
		</div>
	</div>

	<div id="list" class="keep_tabbar">
		<div class="toolbar">
			<h1>List</h1>
		</div>
		<div class="s-scrollwrapper">
			<div>
			工事中
			</div>
		</div>
	</div>

	<div id="memo" class="keep_tabbar">
		<div class="toolbar">
			<h1>Memo</h1>
		</div>
		<div class="s-scrollwrapper">
		<ul class="edit rounded">
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="名前"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="住所"
				id="some_name" /></li>
			<li><input type="text" name="name" placeholder="コメント"
				id="some_name" /></li>
		</ul>
		</div>
	</div>

	<div id="config" class="keep_tabbar">
		<div class="toolbar">
			<h1>Config</h1>
		</div>
		<div class="s-scrollwrapper">
			<div>
			工事中
			</div>
		</div>
	</div>

</div>


</body>
</html>